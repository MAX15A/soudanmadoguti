<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ç®¡ç†ãƒšãƒ¼ã‚¸ï½œäººç”Ÿç·åˆçª“å£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg1:#f7fbff; --bg2:#f2fdf7;
      --card:#ffffff; --ink:#1f2937; --sub:#6b7280;
      --brand:#86efac; --brand-ink:#14532d; --accent:#bfdbfe;
      --border:#e5e7eb; --muted:#9ca3af; --warn:#b45309;
      --radius:14px; --shadow:0 10px 24px rgba(2,6,23,.05);
      --link:#166534; --link-h:#065f46; --danger:#b91c1c; --ok:#047857;
    }
    body{margin:0; color:var(--ink); background:linear-gradient(180deg,var(--bg1),var(--bg2));
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,Arial,sans-serif; line-height:1.65}
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline; color:var(--link-h)}
    .container{width:min(1100px,92vw); margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .sub{color:var(--sub)}
    .note{color:var(--muted); font-size:.92rem}
    .btn{display:inline-block; padding:10px 16px; border-radius:999px; font-weight:700; box-shadow:var(--shadow); border:none; cursor:pointer}
    .btn-primary{background:var(--brand-ink); color:#fff}
    .btn-outline{background:#fff; color:var(--brand-ink); border:2px solid var(--brand-ink)}
    .btn-danger{background:var(--danger); color:#fff}
    .section{padding:24px 0}
    h1{font-size:clamp(22px,4vw,32px); margin:0}
    .h2{font-size:1.2rem; margin:0 0 12px}
    .grid-2{display:grid; gap:16px; grid-template-columns:repeat(2,1fr)}
    .grid-3{display:grid; gap:16px; grid-template-columns:repeat(3,1fr)}
    .stack{display:grid; gap:10px}
    .header{position:sticky; top:0; z-index:10; background:rgba(255,255,255,.9); backdrop-filter:saturate(150%) blur(8px); border-bottom:1px solid var(--border)}
    .nav{display:flex; align-items:center; justify-content:space-between; padding:12px 0}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800}
    .logo-badge{width:40px; height:40px; border-radius:50%; display:grid; place-items:center; background:var(--brand); box-shadow:var(--shadow)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab-btn{padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer}
    .tab-btn.active{background:var(--brand); color:var(--brand-ink); border-color:var(--brand)}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border); padding:8px; text-align:left; vertical-align:top}
    th{background:#f9fafb; font-weight:700}
    tr:hover{background:#f9fbff}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{display:grid; gap:6px}
    input,select,textarea{border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:1rem; background:#fff}
    textarea{min-height:100px; resize:vertical}
    input:focus,select:focus,textarea:focus,button:focus{outline:3px solid #fde68a; outline-offset:1px}
    .pill{border-radius:999px; padding:2px 8px; font-size:.85rem; border:1px solid var(--border); display:inline-block}
    .pill.ok{color:var(--ok); border-color:#d1fae5; background:#ecfdf5}
    .pill.warn{color:var(--warn); border-color:#fde68a; background:#fffbeb}
    .pill.danger{color:var(--danger); border-color:#fecaca; background:#fef2f2}
    .footer{border-top:1px solid var(--border); padding:20px 0; color:var(--sub); font-size:.95rem; margin-top:20px}
    @media (max-width:900px){ .grid-2,.grid-3{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header class="header">
    <div class="container nav">
      <div class="logo">
        <div class="logo-badge" aria-hidden="true">ğŸ—‚ï¸</div>
        <div>
          <div style="font-weight:800;">ç®¡ç†ãƒšãƒ¼ã‚¸</div>
          <div class="sub" style="font-size:.95rem;">äººç”Ÿç·åˆçª“å£ï¼ˆèªè¨¼å¾Œã®ã¿é–²è¦§ï¼‰</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn btn-outline" id="exportAllBtn">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn btn-outline">
          CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          <input type="file" id="importInput" accept=".csv,.txt" multiple style="display:none">
        </label>
        <button class="btn btn-outline" id="syncApiBtn" title="Google Sheetsã‹ã‚‰æœ€æ–°äºˆç´„ã‚’å–å¾—">APIã‹ã‚‰åŒæœŸ</button>
        <button class="btn btn-outline" id="clearLocalBtn">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’å‰Šé™¤</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <div class="tabs">
        <button class="tab-btn active" data-tab="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        <button class="tab-btn" data-tab="clients">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</button>
        <button class="tab-btn" data-tab="sessions">é¢è«‡ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰</button>
        <button class="tab-btn" data-tab="bookings">äºˆç´„</button>
        <button class="tab-btn" data-tab="invoices">è«‹æ±‚</button>
        <button class="tab-btn" data-tab="settings">è¨­å®š</button>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard" class="section card" style="padding:16px;">
      <h2 class="h2">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
      <div class="grid-3">
        <div class="card" style="padding:12px;">
          <div class="sub">ä»Šæ—¥ã®é¢è«‡</div>
          <div style="font-weight:900; font-size:1.6rem;" id="statTodaySessions">0</div>
        </div>
        <div class="card" style="padding:12px;">
          <div class="sub">æœªå‡¦ç†äºˆç´„</div>
          <div style="font-weight:900; font-size:1.6rem;" id="statPendingBookings">0</div>
        </div>
        <div class="card" style="padding:12px;">
          <div class="sub">å…¥é‡‘å¾…ã¡</div>
          <div style="font-weight:900; font-size:1.6rem;" id="statUnpaidInvoices">0</div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:16px;">
        <div class="card" style="padding:12px;">
          <div class="toolbar">
            <div class="field" style="min-width:200px;">
              <label for="searchAll">å…¨ä½“æ¤œç´¢</label>
              <input id="searchAll" type="search" placeholder="æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ†ãƒ¼ãƒãƒ»ã‚¿ã‚°ãªã©">
            </div>
          </div>
          <div id="searchResults" class="note" style="margin-top:8px;">æ¤œç´¢çµæœã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
        <div class="card" style="padding:12px;">
          <div class="stack">
            <div><span class="pill ok">ç¨¼åƒ</span> æ¬¡ã®é¢è«‡ã¾ã§ã®æ™‚é–“ã‚’ç¢ºèªã—ã€æº–å‚™ã‚’é€²ã‚ã¾ã—ã‚‡ã†ã€‚</div>
            <div><span class="pill warn">è¦ãƒ•ã‚©ãƒ­ãƒ¼</span> ä¸€é€±é–“ä»¥ä¸Šé€£çµ¡ãŒé€”çµ¶ãˆã¦ã„ã‚‹æ–¹ã«è¿‘æ³ç¢ºèªã‚’ã€‚</div>
            <div><span class="pill danger">é‡è¦</span> ãƒªã‚¹ã‚¯ãƒ•ãƒ©ã‚°ã®ã‚ã‚‹ã‚±ãƒ¼ã‚¹ã¯æ‹…å½“è€…ã§å…±æœ‰ãƒ»ç¢ºèªã€‚</div>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:16px;">
        <div>
          <h3 class="h2">æœ¬æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
          <table id="todaySessionsTable">
            <thead><tr><th>æ™‚åˆ»</th><th>æ°å</th><th>æ–¹æ³•</th><th>ä¼šå ´/ãƒ„ãƒ¼ãƒ«</th><th>ãƒ¡ãƒ¢</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <h3 class="h2">æœªå‡¦ç†ã®äºˆç´„</h3>
          <table id="pendingBookingsTable">
            <thead><tr><th>æ°å</th><th>å¸Œæœ›æ—¥æ™‚1</th><th>å¸Œæœ›æ—¥æ™‚2</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Clients -->
    <section id="clients" class="section card" style="padding:16px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="h2">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç®¡ç†</h2>
        <button class="btn btn-primary" id="addClientBtn">æ–°è¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¿½åŠ </button>
      </div>

      <div class="toolbar" style="margin-top:10px;">
        <input type="search" id="clientSearch" placeholder="æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»ã‚¿ã‚°ã§æ¤œç´¢" style="min-width:200px;">
        <select id="clientRiskFilter">
          <option value="">ãƒªã‚¹ã‚¯çµã‚Šè¾¼ã¿ãªã—</option>
          <option value="none">ãªã—</option>
          <option value="low">ä½</option>
          <option value="mid">ä¸­</option>
          <option value="high">é«˜</option>
        </select>
        <button class="btn btn-outline" id="exportClientsBtn">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆCSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn btn-outline">
          ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆCSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          <input type="file" id="importClientsInput" accept=".csv" style="display:none">
        </label>
      </div>

      <table id="clientsTable" style="margin-top:10px;">
        <thead>
          <tr>
            <th>æ°å</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>é›»è©±</th><th>å¸‚åŒºç”ºæ‘</th><th>ä¸»è¨´</th><th>ã‚¿ã‚°</th><th>ãƒªã‚¹ã‚¯</th><th>æœ€çµ‚é¢è«‡</th><th>å›æ•°</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="clientFormCard" class="card" style="padding:12px; margin-top:16px; display:none;">
        <h3 class="h2" id="clientFormTitle">æ–°è¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</h3>
        <div class="grid-2">
          <div class="field"><label>æ°å</label><input id="f_name"></div>
          <div class="field"><label>ãƒ¡ãƒ¼ãƒ«</label><input id="f_email" type="email"></div>
          <div class="field"><label>é›»è©±</label><input id="f_phone"></div>
          <div class="field"><label>å¸‚åŒºç”ºæ‘</label><input id="f_city"></div>
          <div class="field"><label>ä¸»è¨´</label><input id="f_main_issue" placeholder="ä¾‹ï¼šä»•äº‹ã®ã‚¹ãƒˆãƒ¬ã‚¹"></div>
          <div class="field"><label>ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label><input id="f_tags" placeholder="ä»•äº‹,å®¶æ—,ç¡çœ "></div>
          <div class="field"><label>ãƒªã‚¹ã‚¯</label>
            <select id="f_risk">
              <option value="none">ãªã—</option>
              <option value="low">ä½</option>
              <option value="mid">ä¸­</option>
              <option value="high">é«˜</option>
            </select>
          </div>
          <div class="field"><label>é…æ…®äº‹é …</label><input id="f_notes"></div>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn btn-primary" id="saveClientBtn">ä¿å­˜</button>
          <button class="btn btn-outline" id="cancelClientBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </section>

    <!-- Sessions -->
    <section id="sessions" class="section card" style="padding:16px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="h2">é¢è«‡ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰ç®¡ç†</h2>
        <button class="btn btn-primary" id="addSessionBtn">æ–°è¦é¢è«‡ã‚’è¨˜éŒ²</button>
      </div>

      <div class="toolbar" style="margin-top:10px;">
        <input type="search" id="sessionSearch" placeholder="æ°åãƒ»æ¦‚è¦ãƒ»ã‚¿ã‚°ã§æ¤œç´¢" style="min-width:200px;">
        <select id="sessionModeFilter">
          <option value="">å½¢æ…‹ï¼ˆå…¨ã¦ï¼‰</option>
          <option value="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</option>
          <option value="å¯¾é¢">å¯¾é¢</option>
        </select>
        <button class="btn btn-outline" id="exportSessionsBtn">é¢è«‡CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn btn-outline">
          é¢è«‡CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          <input type="file" id="importSessionsInput" accept=".csv" style="display:none">
        </label>
      </div>

      <table id="sessionsTable" style="margin-top:10px;">
        <thead>
          <tr>
            <th>æ—¥æ™‚</th><th>æ°å</th><th>å½¢æ…‹</th><th>ãƒ„ãƒ¼ãƒ«/ä¼šå ´</th><th>è¦ç´„</th><th>å®¿é¡Œ</th><th>æ¬¡å›ç›®æ¨™</th><th>å›æ•°</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="sessionFormCard" class="card" style="padding:12px; margin-top:16px; display:none;">
        <h3 class="h2" id="sessionFormTitle">æ–°è¦é¢è«‡</h3>
        <div class="grid-2">
          <div class="field"><label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆæ°åï¼‰</label><input id="s_client_name" list="clientNameList"><datalist id="clientNameList"></datalist></div>
          <div class="field"><label>æ—¥æ™‚</label><input id="s_at" type="datetime-local"></div>
          <div class="field"><label>å½¢æ…‹</label><select id="s_mode"><option>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</option><option>å¯¾é¢</option></select></div>
          <div class="field"><label>ãƒ„ãƒ¼ãƒ«/ä¼šå ´</label><input id="s_tool_or_room" placeholder="Zoom / Google Meet / è¶Šè°·ã‚ªãƒ•ã‚£ã‚¹ãªã©"></div>
          <div class="field"><label>è¦ç´„</label><textarea id="s_summary" placeholder="é¢è«‡ã®è¦ç´„ã€ä»‹å…¥/æŠ€æ³•ãªã©"></textarea></div>
          <div class="field"><label>å®¿é¡Œ</label><input id="s_homework" placeholder="æ¬¡å›ã¾ã§ã®å®¿é¡Œãƒ»è¡Œå‹•"></div>
          <div class="field"><label>æ¬¡å›ç›®æ¨™</label><input id="s_next_goal" placeholder="æ¬¡å›ã®ç›®æ¨™ãƒ»åˆæ„äº‹é …"></div>
          <div class="field"><label>å›æ•°ï¼ˆé€šç®—ï¼‰</label><input id="s_count_index" type="number" min="1" value="1"></div>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn btn-primary" id="saveSessionBtn">ä¿å­˜</button>
          <button class="btn btn-outline" id="cancelSessionBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </section>

    <!-- Bookings -->
    <section id="bookings" class="section card" style="padding:16px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="h2">äºˆç´„ç®¡ç†</h2>
        <button class="btn btn-primary" id="addBookingBtn">æ‰‹å‹•ã§äºˆç´„è¿½åŠ </button>
      </div>

      <div class="toolbar" style="margin-top:10px;">
        <input type="search" id="bookingSearch" placeholder="æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§æ¤œç´¢" style="min-width:200px;">
        <select id="bookingStatusFilter">
          <option value="">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå…¨ã¦ï¼‰</option>
          <option value="ãƒªã‚¯ã‚¨ã‚¹ãƒˆ">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</option>
          <option value="ç¢ºå®š">ç¢ºå®š</option>
          <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
        </select>
        <button class="btn btn-outline" id="exportBookingsBtn">äºˆç´„CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn btn-outline">
          äºˆç´„CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          <input type="file" id="importBookingsInput" accept=".csv" style="display:none">
        </label>
      </div>

      <table id="bookingsTable" style="margin-top:10px;">
        <thead>
          <tr><th>æ°å</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>å¸Œæœ›æ—¥æ™‚1</th><th>å¸Œæœ›æ—¥æ™‚2</th><th>ç¢ºå®šæ—¥æ™‚</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="bookingFormCard" class="card" style="padding:12px; margin-top:16px; display:none;">
        <h3 class="h2" id="bookingFormTitle">æ–°è¦äºˆç´„</h3>
        <div class="grid-2">
          <div class="field"><label>æ°å</label><input id="b_name"></div>
          <div class="field"><label>ãƒ¡ãƒ¼ãƒ«</label><input id="b_email" type="email"></div>
          <div class="field"><label>å¸Œæœ›æ—¥æ™‚1</label><input id="b_desired1" type="datetime-local"></div>
          <div class="field"><label>å¸Œæœ›æ—¥æ™‚2</label><input id="b_desired2" type="datetime-local"></div>
          <div class="field"><label>ç¢ºå®šæ—¥æ™‚</label><input id="b_confirmed" type="datetime-local"></div>
          <div class="field"><label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select id="b_status"><option>ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</option><option>ç¢ºå®š</option><option>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option></select></div>
          <div class="field"><label>ãƒ¡ãƒ¢</label><input id="b_memo"></div>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn btn-primary" id="saveBookingBtn">ä¿å­˜</button>
          <button class="btn btn-outline" id="cancelBookingBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </section>

    <!-- Invoices -->
    <section id="invoices" class="section card" style="padding:16px; display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="h2">è«‹æ±‚ç®¡ç†</h2>
        <button class="btn btn-primary" id="addInvoiceBtn">è«‹æ±‚ã‚’ä½œæˆ</button>
      </div>

      <div class="toolbar" style="margin-top:10px;">
        <input type="search" id="invoiceSearch" placeholder="æ°åãƒ»ç•ªå·ã§æ¤œç´¢" style="min-width:200px;">
        <select id="invoicePaidFilter">
          <option value="">å…¥é‡‘çŠ¶æ³ï¼ˆå…¨ã¦ï¼‰</option>
          <option value="æœªå…¥é‡‘">æœªå…¥é‡‘</option>
          <option value="å…¥é‡‘æ¸ˆã¿">å…¥é‡‘æ¸ˆã¿</option>
        </select>
        <button class="btn btn-outline" id="exportInvoicesBtn">è«‹æ±‚CSVã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <label class="btn btn-outline">
          è«‹æ±‚CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          <input type="file" id="importInvoicesInput" accept=".csv" style="display:none">
        </label>
      </div>

      <table id="invoicesTable" style="margin-top:10px;">
        <thead>
          <tr><th>è«‹æ±‚æ—¥</th><th>æ°å</th><th>é‡‘é¡</th><th>æ±ºæ¸ˆæ–¹æ³•</th><th>å…¥é‡‘çŠ¶æ³</th><th>è«‹æ±‚æ›¸ç•ªå·</th><th>é ˜åæ›¸ç•ªå·</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="invoiceFormCard" class="card" style="padding:12px; margin-top:16px; display:none;">
        <h3 class="h2" id="invoiceFormTitle">æ–°è¦è«‹æ±‚</h3>
        <div class="grid-2">
          <div class="field"><label>æ°å</label><input id="i_name" list="clientNameList2"><datalist id="clientNameList2"></datalist></div>
          <div class="field"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input id="i_amount" type="number" min="0" value="8000"></div>
          <div class="field"><label>æ±ºæ¸ˆæ–¹æ³•</label><select id="i_method"><option>éŠ€è¡ŒæŒ¯è¾¼</option><option>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option></select></div>
          <div class="field"><label>å…¥é‡‘çŠ¶æ³</label><select id="i_paid"><option>æœªå…¥é‡‘</option><option>å…¥é‡‘æ¸ˆã¿</option></select></div>
          <div class="field"><label>è«‹æ±‚æ›¸ç•ªå·</label><input id="i_invoice_no" placeholder="INV-2025-001"></div>
          <div class="field"><label>é ˜åæ›¸ç•ªå·</label><input id="i_receipt_no" placeholder="RCPT-2025-001"></div>
          <div class="field"><label>è«‹æ±‚æ—¥</label><input id="i_issued_at" type="date"></div>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button class="btn btn-primary" id="saveInvoiceBtn">ä¿å­˜</button>
          <button class="btn btn-outline" id="cancelInvoiceBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings" class="section card" style="padding:16px; display:none;">
      <h2 class="h2">è¨­å®šãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h2>
      <div class="grid-2">
        <div class="card" style="padding:12px;">
          <div class="field"><label>åŸºæœ¬æ–™é‡‘ï¼ˆå††ï¼‰</label><input id="set_price" type="number" value="8000"></div>
          <div class="field"><label>é¢è«‡æ™‚é–“ï¼ˆåˆ†ï¼‰</label><input id="set_duration" type="number" value="60"></div>
          <div class="field"><label>åŒæ„æ–‡æ›¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³</label><input id="set_consent_version" placeholder="v1.0"></div>
          <div class="field"><label>ãƒªãƒã‚¤ãƒ³ãƒ‰ã²ãªå½¢</label><textarea id="set_reminder_tpl" placeholder="ä¾‹ï¼šæ˜æ—¥ã®ã”äºˆç´„ã®ç¢ºèª..."></textarea></div>
          <div style="margin-top:10px;"><button class="btn btn-primary" id="saveSettingsBtn">è¨­å®šã‚’ä¿å­˜</button></div>
        </div>
        <div class="card" style="padding:12px;">
          <div class="note">
            CSVã®é …ç›®åãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ï¼ˆ1è¡Œç›®ã«ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
            <ul>
              <li>clients: id,name,email,phone,city,main_issue,tags,risk,last_session_at,count</li>
              <li>sessions: id,client_name,at,mode,tool_or_room,summary,homework,next_goal,count_index</li>
              <li>bookings: id,name,email,desired_at_1,desired_at_2,confirmed_at,status,memo</li>
              <li>invoices: id,name,amount,method,paid,invoice_no,receipt_no,issued_at</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div>Â© äººç”Ÿç·åˆçª“å£ï¼ˆç®¡ç†ãƒšãƒ¼ã‚¸ï¼‰</div>
      <div class="note">ã“ã®ãƒšãƒ¼ã‚¸ã¯å€‹äººæƒ…å ±ã‚’æ‰±ã„ã¾ã™ã€‚èªè¨¼ã®ãªã„å…¬é–‹ç’°å¢ƒã§ã®é‹ç”¨ã¯é¿ã‘ã¦ãã ã•ã„ã€‚</div>
    </footer>
  </main>

  <script>
    // èªè¨¼ã‚¬ãƒ¼ãƒ‰ï¼ˆå…¬é–‹ã‚µã‚¤ãƒˆã‹ã‚‰ã®ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ•ãƒ©ã‚°ç¢ºèªï¼‰
    (function accessGuard(){
      const v = sessionStorage.getItem('admin_unlocked');
      if(v === 'v1'){ return; } // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿

      // æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ç°¡æ˜“UIã‚’è¡¨ç¤º
      document.body.innerHTML = `
        <div style="max-width:420px;margin:40px auto;padding:16px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;box-shadow:0 10px 24px rgba(2,6,23,.05);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP','Hiragino Kaku Gothic ProN',Meiryo,Arial,sans-serif;line-height:1.6;color:#1f2937;">
          <h2 style="margin:0 0 8px;font-size:1.2rem;">ç®¡ç†ãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹</h2>
          <div style="color:#6b7280;">å…¬é–‹ã‚µã‚¤ãƒˆã®ã€Œç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã€ã‹ã‚‰å…¥ã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
          <div style="margin-top:12px;">
            <label style="font-weight:700;display:block;margin-bottom:6px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input id="ad_pw" type="password" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
          </div>
          <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
            <button id="ad_btn" style="padding:8px 14px;border-radius:999px;border:none;background:#14532d;color:#fff;font-weight:700;cursor:pointer;">å…¥å®¤</button>
          </div>
          <div id="ad_msg" style="margin-top:8px;color:#6b7280;font-size:.92rem;"></div>
        </div>
      `;
      document.getElementById('ad_btn').addEventListener('click', ()=>{
        const pw = (document.getElementById('ad_pw').value || '').trim();
        if(pw === 'hisakohisako'){
          sessionStorage.setItem('admin_unlocked','v1');
          location.reload();
        }else{
          document.getElementById('ad_msg').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚';
        }
      });
    })();
  </script>

  <script>
    // ====== ã“ã“ã‹ã‚‰ä¸‹ã¯ç®¡ç†ãƒšãƒ¼ã‚¸ã®æ©Ÿèƒ½ä¸€å¼ï¼ˆå‰å›ã¨åŒæ§˜ï¼‰ ======
    const store = {
      get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; } },
      set(key, val){ localStorage.setItem(key, JSON.stringify(val)); },
      del(key){ localStorage.removeItem(key); }
    };
    const KEY = { clients:'clinic_clients', sessions:'clinic_sessions', bookings:'clinic_bookings', invoices:'clinic_invoices', settings:'clinic_settings' };

    let clients = store.get(KEY.clients, []);
    let sessions = store.get(KEY.sessions, []);
    let bookings = store.get(KEY.bookings, []);
    let invoices = store.get(KEY.invoices, []);
    let settings = store.get(KEY.settings, { price:8000, duration:60, consent_version:'', reminder_tpl:'' });

    const byId = (id) => document.getElementById(id);
    const fmtDate = (s) => !s ? '' : new Date(s).toLocaleString();
    const todayISO = () => new Date().toISOString().slice(0,10);
    const uid = (prefix='ID') => prefix + '-' + Math.random().toString(36).slice(2,8) + '-' + Date.now().toString(36);

    function setActiveTab(tab){
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
      document.querySelectorAll('main section.section.card').forEach(sec => sec.style.display = (sec.id === tab ? 'block' : 'none'));
    }

    function toCSV(rows){
      if(!rows || rows.length === 0) return '';
      const headers = Object.keys(rows[0]);
      const esc = v => String(v ?? '').replace(/"/g,'""');
      const lines = [headers.join(',')];
      for(const r of rows){ lines.push(headers.map(h => `"${esc(r[h])}"`).join(',')); }
      return lines.join('\n');
    }
    function parseCSV(text){
      const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim().length>0);
      const headers = lines.shift().split(',').map(h=>h.replace(/^"|"$/g,''));
      const rows = [];
      for(const line of lines){
        const cols = []; let i=0, inQ=false, cur='';
        while(i < line.length){
          const ch = line[i];
          if(inQ){
            if(ch === '"' && line[i+1] === '"'){ cur += '"'; i+=2; continue; }
            if(ch === '"'){ inQ=false; i++; continue; }
            cur += ch; i++; continue;
          }else{
            if(ch === '"'){ inQ=true; i++; continue; }
            if(ch === ','){ cols.push(cur); cur=''; i++; continue; }
            cur += ch; i++; continue;
          }
        }
        cols.push(cur);
        const obj = {}; headers.forEach((h,idx)=> obj[h] = cols[idx]?.trim() ?? '');
        rows.push(obj);
      }
      return rows;
    }

    function refreshDashboard(){
      const today = new Date(); const y = today.getFullYear(), m = today.getMonth(), d = today.getDate();
      const start = new Date(y,m,d,0,0,0); const end = new Date(y,m,d,23,59,59);
      const todays = sessions.filter(s => { const t = new Date(s.at); return t >= start && t <= end; });
      byId('statTodaySessions').textContent = todays.length;
      const pending = bookings.filter(b => (b.status||'') === 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆ');
      byId('statPendingBookings').textContent = pending.length;
      const unpaid = invoices.filter(i => (i.paid||'æœªå…¥é‡‘') === 'æœªå…¥é‡‘');
      byId('statUnpaidInvoices').textContent = unpaid.length;

      const tbody1 = byId('todaySessionsTable').querySelector('tbody');
      tbody1.innerHTML = todays.sort((a,b)=> new Date(a.at)-new Date(b.at)).map(s => `
        <tr><td>${fmtDate(s.at)}</td><td>${s.client_name||''}</td><td>${s.mode||''}</td><td>${s.tool_or_room||''}</td><td>${s.summary||''}</td></tr>
      `).join('') || '<tr><td colspan="5" class="note">æœ¬æ—¥ã®é¢è«‡ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';

      const tbody2 = byId('pendingBookingsTable').querySelector('tbody');
      tbody2.innerHTML = pending.map(b => `
        <tr><td>${b.name||''}</td><td>${fmtDate(b.desired_at_1)}</td><td>${fmtDate(b.desired_at_2)}</td><td>${b.email||''}</td><td>${b.status||''}</td></tr>
      `).join('') || '<tr><td colspan="5" class="note">æœªå‡¦ç†ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
    }

    function refreshClients(){
      const q = byId('clientSearch').value.trim().toLowerCase();
      const rf = byId('clientRiskFilter').value;
      const tbody = byId('clientsTable').querySelector('tbody');
      const filtered = clients.filter(c => {
        const str = [c.name,c.email,c.phone,c.city,c.main_issue,c.tags].join(' ').toLowerCase();
        const okQ = q ? str.includes(q) : true;
        const okR = rf ? (c.risk||'').toLowerCase() === rf : true;
        return okQ && okR;
      });
      tbody.innerHTML = filtered.map(c => `
        <tr>
          <td>${c.name||''}</td><td>${c.email||''}</td><td>${c.phone||''}</td><td>${c.city||''}</td>
          <td>${c.main_issue||''}</td><td>${c.tags||''}</td>
          <td>${(c.risk||'none')}</td><td>${fmtDate(c.last_session_at)}</td><td>${c.count||0}</td>
          <td>
            <button class="btn btn-outline" onclick="editClient('${c.id}')">ç·¨é›†</button>
            <button class="btn btn-danger" onclick="deleteClient('${c.id}')">å‰Šé™¤</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="10" class="note">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæœªç™»éŒ²ã§ã™</td></tr>';

      const dl = byId('clientNameList'); dl.innerHTML = clients.map(c=>`<option value="${c.name}">`).join('');
      const dl2 = byId('clientNameList2'); dl2.innerHTML = dl.innerHTML;
    }
    function showClientForm(editId=null){
      byId('clientFormCard').style.display = 'block';
      if(editId){
        const c = clients.find(x=>x.id===editId);
        byId('clientFormTitle').textContent = 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç·¨é›†';
        byId('f_name').value = c.name||'';
        byId('f_email').value = c.email||'';
        byId('f_phone').value = c.phone||'';
        byId('f_city').value = c.city||'';
        byId('f_main_issue').value = c.main_issue||'';
        byId('f_tags').value = c.tags||'';
        byId('f_risk').value = c.risk||'none';
        byId('f_notes').value = c.notes||'';
        byId('saveClientBtn').dataset.editId = editId;
      }else{
        byId('clientFormTitle').textContent = 'æ–°è¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ';
        ['f_name','f_email','f_phone','f_city','f_main_issue','f_tags','f_risk','f_notes'].forEach(id=>byId(id).value='');
        byId('f_risk').value='none';
        delete byId('saveClientBtn').dataset.editId;
      }
    }
    function editClient(id){ showClientForm(id); }
    function deleteClient(id){
      if(!confirm('ã“ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      clients = clients.filter(c=>c.id!==id);
      store.set(KEY.clients, clients);
      refreshClients();
      refreshDashboard();
    }

    function refreshSessions(){
      const q = byId('sessionSearch').value.trim().toLowerCase();
      const mf = byId('sessionModeFilter').value;
      const tbody = byId('sessionsTable').querySelector('tbody');
      const filtered = sessions.filter(s => {
        const str = [s.client_name,s.summary,s.homework,s.next_goal].join(' ').toLowerCase();
        const okQ = q ? str.includes(q) : true;
        const okM = mf ? (s.mode||'') === mf : true;
        return okQ && okM;
      }).sort((a,b)=> new Date(b.at)-new Date(a.at));
      tbody.innerHTML = filtered.map(s => `
        <tr>
          <td>${fmtDate(s.at)}</td><td>${s.client_name||''}</td><td>${s.mode||''}</td><td>${s.tool_or_room||''}</td>
          <td>${s.summary||''}</td><td>${s.homework||''}</td><td>${s.next_goal||''}</td><td>${s.count_index||''}</td>
          <td>
            <button class="btn btn-outline" onclick="editSession('${s.id}')">ç·¨é›†</button>
            <button class="btn btn-danger" onclick="deleteSession('${s.id}')">å‰Šé™¤</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="9" class="note">é¢è«‡è¨˜éŒ²ãŒæœªç™»éŒ²ã§ã™</td></tr>';
    }
    function showSessionForm(editId=null){
      byId('sessionFormCard').style.display = 'block';
      if(editId){
        const s = sessions.find(x=>x.id===editId);
        byId('sessionFormTitle').textContent = 'é¢è«‡ã‚’ç·¨é›†';
        byId('s_client_name').value = s.client_name||'';
        byId('s_at').value = s.at ? s.at.slice(0,16) : '';
        byId('s_mode').value = s.mode||'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
        byId('s_tool_or_room').value = s.tool_or_room||'';
        byId('s_summary').value = s.summary||'';
        byId('s_homework').value = s.homework||'';
        byId('s_next_goal').value = s.next_goal||'';
        byId('s_count_index').value = s.count_index||1;
        byId('saveSessionBtn').dataset.editId = editId;
      }else{
        byId('sessionFormTitle').textContent = 'æ–°è¦é¢è«‡';
        ['s_client_name','s_at','s_mode','s_tool_or_room','s_summary','s_homework','s_next_goal','s_count_index'].forEach(id=>byId(id).value='');
        byId('s_mode').value='ã‚ªãƒ³ãƒ©ã‚¤ãƒ³'; byId('s_count_index').value=1;
        delete byId('saveSessionBtn').dataset.editId;
      }
    }
    function editSession(id){ showSessionForm(id); }
    function deleteSession(id){
      if(!confirm('ã“ã®é¢è«‡è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      sessions = sessions.filter(s=>s.id!==id);
      store.set(KEY.sessions, sessions);
      refreshSessions();
      refreshDashboard();
    }

    function refreshBookings(){
      const q = byId('bookingSearch').value.trim().toLowerCase();
      const sf = byId('bookingStatusFilter').value;
      const tbody = byId('bookingsTable').querySelector('tbody');
      const filtered = bookings.filter(b => {
        const str = [b.name,b.email,b.status,b.memo].join(' ').toLowerCase();
        const okQ = q ? str.includes(q) : true;
        const okS = sf ? (b.status||'') === sf : true;
        return okQ && okS;
      }).sort((a,b)=> (b.confirmed_at||'') < (a.confirmed_at||'') ? -1 : 1);
      tbody.innerHTML = filtered.map(b => `
        <tr>
          <td>${b.name||''}</td><td>${b.email||''}</td><td>${fmtDate(b.desired_at_1)}</td><td>${fmtDate(b.desired_at_2)}</td>
          <td>${fmtDate(b.confirmed_at)}</td><td>${b.status||''}</td><td>${b.memo||''}</td>
          <td>
            <button class="btn btn-outline" onclick="editBooking('${b.id}')">ç·¨é›†</button>
            <button class="btn btn-danger" onclick="deleteBooking('${b.id}')">å‰Šé™¤</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="8" class="note">äºˆç´„ãŒæœªç™»éŒ²ã§ã™</td></tr>';
    }
    function showBookingForm(editId=null){
      byId('bookingFormCard').style.display = 'block';
      if(editId){
        const b = bookings.find(x=>x.id===editId);
        byId('bookingFormTitle').textContent = 'äºˆç´„ã‚’ç·¨é›†';
        byId('b_name').value = b.name||''; byId('b_email').value=b.email||'';
        byId('b_desired1').value = b.desired_at_1 ? b.desired_at_1.slice(0,16) : '';
        byId('b_desired2').value = b.desired_at_2 ? b.desired_at_2.slice(0,16) : '';
        byId('b_confirmed').value = b.confirmed_at ? b.confirmed_at.slice(0,16) : '';
        byId('b_status').value = b.status||'ãƒªã‚¯ã‚¨ã‚¹ãƒˆ';
        byId('b_memo').value = b.memo||'';
        byId('saveBookingBtn').dataset.editId = editId;
      }else{
        byId('bookingFormTitle').textContent = 'æ–°è¦äºˆç´„';
        ['b_name','b_email','b_desired1','b_desired2','b_confirmed','b_status','b_memo'].forEach(id=>byId(id).value='');
        byId('b_status').value='ãƒªã‚¯ã‚¨ã‚¹ãƒˆ';
        delete byId('saveBookingBtn').dataset.editId;
      }
    }
    function editBooking(id){ showBookingForm(id); }
    function deleteBooking(id){
      if(!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      bookings = bookings.filter(b=>b.id!==id);
      store.set(KEY.bookings, bookings);
      refreshBookings();
      refreshDashboard();
    }

    function refreshInvoices(){
      const q = byId('invoiceSearch').value.trim().toLowerCase();
      const pf = byId('invoicePaidFilter').value;
      const tbody = byId('invoicesTable').querySelector('tbody');
      const filtered = invoices.filter(i => {
        const str = [i.name,i.invoice_no,i.receipt_no].join(' ').toLowerCase();
        const okQ = q ? str.includes(q) : true;
        const okP = pf ? (i.paid||'æœªå…¥é‡‘') === pf : true;
        return okQ && okP;
      }).sort((a,b)=> (b.issued_at||'') < (a.issued_at||'') ? -1 : 1);
      tbody.innerHTML = filtered.map(i => `
        <tr>
          <td>${i.issued_at||''}</td><td>${i.name||''}</td><td>${i.amount||0}</td><td>${i.method||''}</td>
          <td>${i.paid||'æœªå…¥é‡‘'}</td><td>${i.invoice_no||''}</td><td>${i.receipt_no||''}</td>
          <td>
            <button class="btn btn-outline" onclick="editInvoice('${i.id}')">ç·¨é›†</button>
            <button class="btn btn-danger" onclick="deleteInvoice('${i.id}')">å‰Šé™¤</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="8" class="note">è«‹æ±‚ãŒæœªç™»éŒ²ã§ã™</td></tr>';
    }
    function showInvoiceForm(editId=null){
      byId('invoiceFormCard').style.display = 'block';
      if(editId){
        const i = invoices.find(x=>x.id===editId);
        byId('invoiceFormTitle').textContent = 'è«‹æ±‚ã‚’ç·¨é›†';
        byId('i_name').value = i.name||'';
        byId('i_amount').value = i.amount||settings.price||8000;
        byId('i_method').value = i.method||'éŠ€è¡ŒæŒ¯è¾¼';
        byId('i_paid').value = i.paid||'æœªå…¥é‡‘';
        byId('i_invoice_no').value = i.invoice_no||'';
        byId('i_receipt_no').value = i.receipt_no||'';
        byId('i_issued_at').value = i.issued_at||todayISO();
        byId('saveInvoiceBtn').dataset.editId = editId;
      }else{
        byId('invoiceFormTitle').textContent = 'æ–°è¦è«‹æ±‚';
        byId('i_name').value = '';
        byId('i_amount').value = settings.price||8000;
        byId('i_method').value = 'éŠ€è¡ŒæŒ¯è¾¼';
        byId('i_paid').value = 'æœªå…¥é‡‘';
        byId('i_invoice_no').value = '';
        byId('i_receipt_no').value = '';
        byId('i_issued_at').value = todayISO();
        delete byId('saveInvoiceBtn').dataset.editId;
      }
    }
    function editInvoice(id){ showInvoiceForm(id); }
    function deleteInvoice(id){
      if(!confirm('ã“ã®è«‹æ±‚ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      invoices = invoices.filter(i=>i.id!==id);
      store.set(KEY.invoices, invoices);
      refreshInvoices();
      refreshDashboard();
    }

    byId('saveClientBtn').addEventListener('click', () => {
      const editId = byId('saveClientBtn').dataset.editId;
      const c = {
        id: editId || uid('C'),
        name: byId('f_name').value.trim(),
        email: byId('f_email').value.trim(),
        phone: byId('f_phone').value.trim(),
        city: byId('f_city').value.trim(),
        main_issue: byId('f_main_issue').value.trim(),
        tags: byId('f_tags').value.trim(),
        risk: byId('f_risk').value,
        notes: byId('f_notes').value.trim(),
        last_session_at: editId ? (clients.find(x=>x.id===editId)?.last_session_at || '') : '',
        count: editId ? (clients.find(x=>x.id===editId)?.count || 0) : 0
      };
      if(editId){ clients = clients.map(x => x.id===editId ? c : x); } else { clients.push(c); }
      store.set(KEY.clients, clients);
      byId('clientFormCard').style.display = 'none';
      refreshClients();
    });
    byId('cancelClientBtn').addEventListener('click', () => byId('clientFormCard').style.display='none');
    byId('addClientBtn').addEventListener('click', () => showClientForm());

    byId('saveSessionBtn').addEventListener('click', () => {
      const editId = byId('saveSessionBtn').dataset.editId;
      const s = {
        id: editId || uid('S'),
        client_name: byId('s_client_name').value.trim(),
        at: byId('s_at').value ? new Date(byId('s_at').value).toISOString() : '',
        mode: byId('s_mode').value,
        tool_or_room: byId('s_tool_or_room').value.trim(),
        summary: byId('s_summary').value.trim(),
        homework: byId('s_homework').value.trim(),
        next_goal: byId('s_next_goal').value.trim(),
        count_index: parseInt(byId('s_count_index').value||'1',10)
      };
      if(editId){ sessions = sessions.map(x => x.id===editId ? s : x); } else { sessions.push(s); }
      const c = clients.find(x=>x.name===s.client_name);
      if(c){
        c.last_session_at = s.at;
        c.count = Math.max( (c.count||0), s.count_index||1 );
        clients = clients.map(x => x.id===c.id ? c : x);
        store.set(KEY.clients, clients);
      }
      store.set(KEY.sessions, sessions);
      byId('sessionFormCard').style.display = 'none';
      refreshSessions(); refreshClients(); refreshDashboard();
    });
    byId('cancelSessionBtn').addEventListener('click', () => byId('sessionFormCard').style.display='none');
    byId('addSessionBtn').addEventListener('click', () => showSessionForm());

    byId('saveBookingBtn').addEventListener('click', () => {
      const editId = byId('saveBookingBtn').dataset.editId;
      const b = {
        id: editId || uid('B'),
        name: byId('b_name').value.trim(),
        email: byId('b_email').value.trim(),
        desired_at_1: byId('b_desired1').value ? new Date(byId('b_desired1').value).toISOString() : '',
        desired_at_2: byId('b_desired2').value ? new Date(byId('b_desired2').value).toISOString() : '',
        confirmed_at: byId('b_confirmed').value ? new Date(byId('b_confirmed').value).toISOString() : '',
        status: byId('b_status').value,
        memo: byId('b_memo').value.trim()
      };
      if(editId){ bookings = bookings.map(x => x.id===editId ? b : x); } else { bookings.push(b); }
      store.set(KEY.bookings, bookings);
      byId('bookingFormCard').style.display = 'none';
      refreshBookings(); refreshDashboard();
    });
    byId('cancelBookingBtn').addEventListener('click', () => byId('bookingFormCard').style.display='none');
    byId('addBookingBtn').addEventListener('click', () => showBookingForm());

    byId('saveInvoiceBtn').addEventListener('click', () => {
      const editId = byId('saveInvoiceBtn').dataset.editId;
      const i = {
        id: editId || uid('I'),
        name: byId('i_name').value.trim(),
        amount: parseInt(byId('i_amount').value||'0',10),
        method: byId('i_method').value,
        paid: byId('i_paid').value,
        invoice_no: byId('i_invoice_no').value.trim(),
        receipt_no: byId('i_receipt_no').value.trim(),
        issued_at: byId('i_issued_at').value
      };
      if(editId){ invoices = invoices.map(x => x.id===editId ? i : x); } else { invoices.push(i); }
      store.set(KEY.invoices, invoices);
      byId('invoiceFormCard').style.display = 'none';
      refreshInvoices(); refreshDashboard();
    });
    byId('cancelInvoiceBtn').addEventListener('click', () => byId('invoiceFormCard').style.display='none');
    byId('addInvoiceBtn').addEventListener('click', () => showInvoiceForm());

    byId('clientSearch').addEventListener('input', refreshClients);
    byId('clientRiskFilter').addEventListener('change', refreshClients);
    byId('sessionSearch').addEventListener('input', refreshSessions);
    byId('sessionModeFilter').addEventListener('change', refreshSessions);
    byId('bookingSearch').addEventListener('input', refreshBookings);
    byId('bookingStatusFilter').addEventListener('change', refreshBookings);
    byId('invoiceSearch').addEventListener('input', refreshInvoices);
    byId('invoicePaidFilter').addEventListener('change', refreshInvoices);

    function refreshSettingsUI(){
      byId('set_price').value = settings.price||8000;
      byId('set_duration').value = settings.duration||60;
      byId('set_consent_version').value = settings.consent_version||'';
      byId('set_reminder_tpl').value = settings.reminder_tpl||'';
    }
    byId('saveSettingsBtn').addEventListener('click', () => {
      settings.price = parseInt(byId('set_price').value||'8000',10);
      settings.duration = parseInt(byId('set_duration').value||'60',10);
      settings.consent_version = byId('set_consent_version').value.trim();
      settings.reminder_tpl = byId('set_reminder_tpl').value.trim();
      store.set(KEY.settings, settings);
      alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    document.querySelectorAll('.tab-btn').forEach(btn => { btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)); });

    function download(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }
    byId('exportClientsBtn').addEventListener('click', () => download('clients.csv', toCSV(clients)));
    byId('exportSessionsBtn').addEventListener('click', () => download('sessions.csv', toCSV(sessions)));
    byId('exportBookingsBtn').addEventListener('click', () => download('bookings.csv', toCSV(bookings)));
    byId('exportInvoicesBtn').addEventListener('click', () => download('invoices.csv', toCSV(invoices)));
    byId('exportAllBtn').addEventListener('click', () => {
      byId('exportClientsBtn').click();
      setTimeout(()=>byId('exportSessionsBtn').click(), 300);
      setTimeout(()=>byId('exportBookingsBtn').click(), 600);
      setTimeout(()=>byId('exportInvoicesBtn').click(), 900);
    });

    function handleCSVImport(file, target){
      const reader = new FileReader();
      reader.onload = () => {
        const rows = parseCSV(reader.result);
        if(target==='clients'){
          clients = rows.map(r => ({
            id: r.id || uid('C'), name: r.name||'', email: r.email||'', phone: r.phone||'',
            city: r.city||'', main_issue: r.main_issue||'', tags: r.tags||'', risk: (r.risk||'none'),
            last_session_at: r.last_session_at||'', count: parseInt(r.count||'0',10)
          }));
          store.set(KEY.clients, clients); refreshClients();
        }else if(target==='sessions'){
          sessions = rows.map(r => ({
            id: r.id || uid('S'), client_name: r.client_name||'', at: r.at||'', mode: r.mode||'',
            tool_or_room: r.tool_or_room||'', summary: r.summary||'', homework: r.homework||'',
            next_goal: r.next_goal||'', count_index: parseInt(r.count_index||'1',10)
          }));
          store.set(KEY.sessions, sessions); refreshSessions(); refreshDashboard();
        }else if(target==='bookings'){
          bookings = rows.map(r => ({
            id: r.id || uid('B'), name: r.name||'', email: r.email||'', desired_at_1: r.desired_at_1||'',
            desired_at_2: r.desired_at_2||'', confirmed_at: r.confirmed_at||'', status: r.status||'', memo: r.memo||''
          }));
          store.set(KEY.bookings, bookings); refreshBookings(); refreshDashboard();
        }else if(target==='invoices'){
          invoices = rows.map(r => ({
            id: r.id || uid('I'), name: r.name||'', amount: parseInt(r.amount||'0',10), method: r.method||'',
            paid: r.paid||'æœªå…¥é‡‘', invoice_no: r.invoice_no||'', receipt_no: r.receipt_no||'', issued_at: r.issued_at||''
          }));
          store.set(KEY.invoices, invoices); refreshInvoices(); refreshDashboard();
        }
        alert(`${file.name} ã‚’ ${target} ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      };
      reader.readAsText(file, 'UTF-8');
    }
    byId('importClientsInput').addEventListener('change', (e) => { const f = e.target.files[0]; if(f) handleCSVImport(f, 'clients'); e.target.value=''; });
    byId('importSessionsInput').addEventListener('change', (e) => { const f = e.target.files[0]; if(f) handleCSVImport(f, 'sessions'); e.target.value=''; });
    byId('importBookingsInput').addEventListener('change', (e) => { const f = e.target.files[0]; if(f) handleCSVImport(f, 'bookings'); e.target.value=''; });
    byId('importInvoicesInput').addEventListener('change', (e) => { const f = e.target.files[0]; if(f) handleCSVImport(f, 'invoices'); e.target.value=''; });

    byId('importInput').addEventListener('change', (e) => {
      for(const f of e.target.files){
        const name = f.name.toLowerCase();
        if(name.startsWith('clients')) handleCSVImport(f, 'clients');
        else if(name.startsWith('sessions')) handleCSVImport(f, 'sessions');
        else if(name.startsWith('bookings')) handleCSVImport(f, 'bookings');
        else if(name.startsWith('invoices')) handleCSVImport(f, 'invoices');
        else alert(`${f.name} ã®å¯¾è±¡ãŒç‰¹å®šã§ãã¾ã›ã‚“ï¼ˆclients/sessions/bookings/invoices ã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã«ã—ã¦ãã ã•ã„ï¼‰`);
      }
      e.target.value='';
    });

    byId('clearLocalBtn').addEventListener('click', () => {
      if(!confirm('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆã“ã®PCå†…ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      ['clients','sessions','bookings','invoices','settings'].forEach(k => store.del(KEY[k]));
      clients=[]; sessions=[]; bookings=[]; invoices=[]; settings={ price:8000,duration:60,consent_version:'',reminder_tpl:'' };
      refreshClients(); refreshSessions(); refreshBookings(); refreshInvoices(); refreshDashboard(); refreshSettingsUI();
      alert('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });

    byId('searchAll').addEventListener('input', () => {
      const q = byId('searchAll').value.trim().toLowerCase();
      const items = [];
      clients.forEach(c => { const str = [c.name,c.email,c.phone,c.city,c.main_issue,c.tags,c.notes].join(' ').toLowerCase(); if(q && str.includes(q)) items.push(`ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ${c.name} / ${c.email}`); });
      sessions.forEach(s => { const str = [s.client_name,s.summary,s.homework,s.next_goal,s.tool_or_room].join(' ').toLowerCase(); if(q && str.includes(q)) items.push(`é¢è«‡: ${s.client_name} @ ${fmtDate(s.at)}`); });
      bookings.forEach(b => { const str = [b.name,b.email,b.status,b.memo].join(' ').toLowerCase(); if(q && str.includes(q)) items.push(`äºˆç´„: ${b.name} / ${b.status}`); });
      invoices.forEach(i => { const str = [i.name,i.invoice_no,i.receipt_no,i.paid].join(' ').toLowerCase(); if(q && str.includes(q)) items.push(`è«‹æ±‚: ${i.name} / ${i.paid}`); });
      byId('searchResults').textContent = items.length ? items.join(' / ') : 'æ¤œç´¢çµæœã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
    });

    refreshDashboard(); refreshClients(); refreshSessions(); refreshBookings(); refreshInvoices(); refreshSettingsUI();
    setActiveTab('dashboard');

    // APIåŒæœŸï¼ˆå¿…è¦ãªã‚‰è¨­å®šå€¤ã«ç½®ãæ›ãˆï¼‰
    const API_URL = 'https://script.google.com/macros/s/AKfycbzXwrHBs8vm_EuhWfkCqiRou1Alu-API2MzjvIx_GQIVTd-aZ0__Zt8_ryp8rIouCB1/exec';
    const TOKEN   = 'rD9aZx7NwQ2pLm8T_vG4yH1kE6oB3cJ0fS5uR9tY2nM8dF4lP1iX6eA3qV0wG5zU9-~C7';

    async function syncFromAPI(){
      try{
        const url = API_URL + '?token=' + encodeURIComponent(TOKEN);
        const res = await fetch(url, { method:'GET' });
        const json = await res.json();
        if(!json.ok){ alert('APIãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸æ­£ã€ã¾ãŸã¯æ¨©é™ä¸è¶³ã§ã™'); return; }
        applyBookings(json.data || []);
      }catch(_){
        // å¿…è¦ãªã‚‰JSONPãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¿½åŠ å¯èƒ½
        alert('APIåŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸã€‚URL/ãƒˆãƒ¼ã‚¯ãƒ³/æ¨©é™ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
      }
    }
    function applyBookings(rows){
      const incoming = rows.map(r => ({
        id: r.timestamp ? String(new Date(r.timestamp).getTime()) : uid('B'),
        name: r.name || '',
        email: r.email || '',
        desired_at_1: r.datetime1 ? new Date(r.datetime1).toISOString() : '',
        desired_at_2: r.datetime2 ? new Date(r.datetime2).toISOString() : '',
        confirmed_at: '',
        status: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆ',
        memo: [r.method||'', r.online_tool||'', r.office||''].filter(Boolean).join(' / ')
      }));
      const existIds = new Set(bookings.map(b => b.id));
      const newOnes = incoming.filter(b => !existIds.has(b.id));
      bookings = bookings.concat(newOnes);
      store.set(KEY.bookings, bookings);

      let addedClients = 0;
      newOnes.forEach(b => {
        const e = (b.email||'').trim().toLowerCase();
        const n = (b.name||'').trim();
        const exists = clients.find(c => (c.email||'').trim().toLowerCase() === e) || clients.find(c => c.name === n);
        if(!exists){
          clients.push({ id: uid('C'), name: b.name, email: b.email, phone:'', city:'', main_issue:'', tags:'æ–°è¦äºˆç´„', risk:'none', notes:'', last_session_at:'', count:0 });
          addedClients++;
        }
      });
      if(addedClients) store.set(KEY.clients, clients);

      refreshBookings(); refreshClients(); refreshDashboard();
      alert(`APIã‹ã‚‰äºˆç´„ ${newOnes.length}ä»¶ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ${addedClients}ä»¶ã‚’åŒæœŸã—ã¾ã—ãŸ`);
    }
    document.getElementById('syncApiBtn')?.addEventListener('click', syncFromAPI);
  </script>
</body>
</html>
